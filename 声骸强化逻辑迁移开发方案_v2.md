# 声骸强化逻辑迁移技术方案 (v2.0)

## 1. 架构调整与模块划分

为了满足生成独立 EXE、独立模块启动、UI 交互以及翻页逻辑的需求，我们将架构分层：

```
ok-ww/
├── src/
│   ├── echo/                  # [核心领域层] 声骸相关业务逻辑
│   │   ├── __init__.py
│   │   ├── profile.py         # 数据模型 (EchoProfile, EntryCoef) - 已有
│   │   ├── calculate.py       # [新] 纯 Python 概率/评分/期望算法 - 已完成
│   │   ├── stats.py           # [新] 数据统计与配置加载 (管理 entry_stats.yml) - 已完成
│   │   ├── vision.py          # [新] 视觉识别层 (OCR解析, 坐标映射) - 框架完成，待填坐标
│   │   └── actions.py         # [新] 动作执行层 (强化, 调谐, 翻页, 弃置) - 框架完成，待填坐标
│   ├── gui/                   # [UI交互层]
│   │   ├── echo_interface.py  # [新] 声骸工具专属 UI 界面 (PySide6) - 已完成
│   │   └── ...
│   ├── task/
│   │   └── AutoEnhanceEchoTask.py # [任务层] 具体的自动化任务脚本 - 已重构
└── assets/
    └── config/                # 配置文件
```

## 2. 已完成工作 (Step 1-4)
- **Step 1 (算法层)**: `calculate.py` 和 `stats.py` 开发完成，实现了基于组合卷积的概率计算算法。
- **Step 2 (视觉层)**: `vision.py` 框架开发完成，实现了 OCR 文本清洗和属性匹配逻辑。
- **Step 3 (UI层)**: `echo_interface.py` 开发完成，基于 PySide6 实现了配置界面。
- **Step 4 (集成)**: `AutoEnhanceEchoTask.py` 重构完成，实现了智能强化的状态机循环。

## 3. 下一步行动计划 (待调试)

### 3.1 坐标校准 (Vision & Actions)
**需要您提供游戏截图**，以便填充以下坐标：
*   **Vision**:
    *   等级显示区域 (Level Box)
    *   副词条列表区域 (Sub Stats List Box)
    *   套装名称区域 (Set Name Box)
    *   Cost 显示区域 (Cost Box)
*   **Actions**:
    *   “自动加入”按钮 (Auto Add Button)
    *   “强化”按钮 (Enhance Button)
    *   “调谐”按钮 (Tune Button)
    *   “下一个”按钮 (Next Arrow)
    *   “锁定”/“弃置”图标

### 3.2 UI 挂载
需要找到 `ok-ww` 的主 GUI 入口（可能是 `main.py` 或某个 `MainWindow` 类），将 `EchoInterface` 添加到 Tab 页或作为独立窗口启动。

### 3.3 验证测试
*   **单元测试**: 测试 `calculate.py` 的评分准确性。
*   **集成测试**: 在游戏内运行任务，观察日志输出是否正确识别属性并给出合理建议。